<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é£›ç£éµè·¯é§•é§›æ¨¡æ“¬å™¨</title>
    <style>
        :root {
            --bg-body: #000;
            --bg-panel: #141414;
            --color-ato: #00ccff;   
            --color-atp: #ffaa00;   
            --color-ok: #00ff00;    
            --color-err: #ff3333;   
            --font-main: "Consolas", "Microsoft JhengHei", sans-serif;
        }

        html, body { width: 100%; height: 100%; margin: 0; overflow: hidden; background-color: var(--bg-body); font-family: var(--font-main); color: #eee; user-select: none; display: flex; flex-direction: column; }

        /* --- è¦†è“‹å±¤ --- */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .box { background: #222; border: 3px solid var(--color-ato); border-radius: 10px; padding: 30px; width: 90%; max-width: 500px; text-align: center; }
        select { width: 100%; padding: 10px; background: #333; color: #fff; margin: 10px 0; border: 1px solid #555; font-size: 16px; }
        button { width: 100%; padding: 15px; font-size: 20px; background: var(--color-ok); border: none; font-weight: bold; cursor: pointer; margin-top: 20px; border-radius: 5px; color:#000; }
        .fail-box { border-color: var(--color-err); }
        .win-box { border-color: var(--color-ok); }

        /* --- è¦–çª— --- */
        #viewport {
            position: relative; flex: 60;
            background: linear-gradient(to bottom, #87CEEB 0%, #dff 100%);
            overflow: hidden; border-bottom: 5px solid #333;
            cursor: pointer;
        }
        .scenery-layer { position: absolute; bottom: 80px; width: 100%; height: 400px; opacity: 0.8; }
        #city-bg { background: repeating-linear-gradient(90deg, #b0c4de 0px, #b0c4de 100px, transparent 100px, transparent 300px); height: 100%; bottom: 0; }
        
        /* æœˆå°é•·åº¦ 1750px (175m) */
        #platform-obj { 
            position: absolute; bottom: 80px; 
            width: 1750px; height: 120px; 
            background: linear-gradient(to bottom, #aaa, #888); 
            border-top: 5px solid #ffcc00; 
            z-index: 4; 
        }
        
        #stop-marker { position: absolute; bottom: 80px; width: 20px; height: 200px; z-index: 5; display: flex; flex-direction: column; align-items: center; }
        .stop-sign { width: 40px; height: 40px; background: #fff; border: 3px solid #f00; border-radius: 50%; color: #f00; font-weight: bold; font-size: 24px; text-align: center; line-height: 35px; }
        .stop-pole { width: 6px; height: 100%; background: #ddd; border: 1px solid #999; }
        
        /* é»‘ç·šå·¦ç§»è‡³ 20% */
        #train-line {
            position: absolute; bottom: 0; 
            left: 20%; transform: translateX(-50%);
            width: 6px; height: 100%; background: #000; z-index: 20;
            border-left: 1px solid #fff; border-right: 1px solid #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .track { position: absolute; bottom: 0; width: 100%; height: 80px; background: #333; border-top: 8px solid #666; z-index: 5;}
        .sleeper { position: absolute; bottom: 0; width: 100%; height: 80px; background: repeating-linear-gradient(90deg, transparent 0, transparent 40px, #111 40px, #111 50px); }
        
        #station-sign { 
            position: absolute; top: 40px; left: 200%;
            background: #fff; color: #004b87; border: 4px solid #004b87; padding: 10px 20px; 
            font-weight: 900; font-size: 24px; border-radius: 4px; z-index: 5; white-space: nowrap;
        }
        
        #msg-center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); color: #fff; padding: 30px 50px;
            font-size: 36px; display: none; z-index: 100; border-radius: 15px;
            border: 4px solid var(--color-atp); text-align: center; font-weight: bold;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            white-space: pre-line;
        }

        /* --- å„€è¡¨æ¿ --- */
        #dashboard { position: relative; flex: 40; background-color: var(--bg-panel); display: flex; box-shadow: inset 0 10px 20px rgba(0,0,0,0.8); }
        .panel-signal { flex: 3; border-right: 2px solid #333; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        
        .speed-gauge-wrap { position: relative; height: 180px; width: 180px; margin: 5px 0; }
        .speed-num { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.5em; font-weight: bold; color: var(--color-ato); line-height: 1; }
        
        .ring-bg { fill: none; stroke: #222; stroke-width: 20; }
        .ring-limit { fill: none; stroke: var(--color-atp); stroke-width: 20; stroke-linecap: butt; transform: rotate(-90deg); transform-origin: 50% 50%; stroke-dasharray: 0 1000; transition: stroke-dasharray 0.1s linear; opacity: 0.8; }
        .ring-val { fill: none; stroke: var(--color-ato); stroke-width: 12; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; stroke-dasharray: 0 1000; transition: stroke-dasharray 0.1s linear; }
        .flashing { animation: blink 0.2s infinite; }

        .lamp { width: 90%; text-align: center; padding: 5px; background: #333; margin-top: 5px; border-radius: 4px; color: #555; font-weight: bold; font-size: 0.8em; }
        .lamp.on { background: var(--color-err); color: #fff; box-shadow: 0 0 10px #ff3333; }
        .lamp.warn { background: var(--color-atp); color: #000; box-shadow: 0 0 10px var(--color-atp); animation: blink 0.5s infinite; }

        .ma-container { width: 90%; margin-top: auto; background: #111; border: 1px solid #444; padding: 5px; border-radius: 8px; }
        
        /* åœè»Šè¦æ¨£å¼ */
        #stop-gauge {
            position: relative; width: 100%; height: 25px; 
            background: #ccc; 
            margin-top: 5px; border-radius: 4px; overflow: hidden; 
            border: 2px solid #555;
        }
        #stop-gauge-line {
            position: absolute; left: 50%; top: 0; height: 100%; width: 2px; 
            background: #000; 
            transform: translateX(-50%); z-index: 5;
        }
        #stop-gauge-dot {
            position: absolute; top: 50%; width: 12px; height: 12px; 
            background: #f00; 
            border-radius: 50%; transform: translate(-50%, -50%); 
            display: none; z-index: 10; 
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }

        .panel-tcms { flex: 3; border-right: 2px solid #333; padding: 10px; display: flex; flex-direction: column; }
        
        #ui-status-monitor { background: #222; border: 1px solid #555; color: #888; padding: 10px; margin-top: 10px; text-align: center; font-weight: bold; font-size: 1.1em; border-radius: 5px;}
        
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; }
        .data-item { background: #222; padding: 5px; border-radius: 4px; border: 1px solid #444; text-align: center; }
        .data-lbl { color: #888; font-size: 0.6em; }
        .data-val { color: #fff; font-size: 0.9em; font-weight: bold; }

        .panel-controls { flex: 2; background: #222; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .lever-group { display: flex; width: 100%; justify-content: space-around; height: 80%; }
        .lever-track { position: relative; width: 30px; background: #111; border: 1px solid #555; border-radius: 10px; height: 100%; }
        .lever-handle { position: absolute; left: 2px; width: 24px; height: 20px; border-radius: 5px; transition: top 0.1s; box-shadow: 0 2px 5px #000; z-index: 10; cursor: grab; }
        #handle-pwr { background: #00cc00; top: 90%; }
        #handle-brk { background: #ff3333; top: 50%; }

.lever-track {
    touch-action: none; /* ç¦ç”¨ç€è¦½å™¨é»˜èªè§¸æ§è¡Œç‚ºï¼Œé˜²æ­¢ç•«é¢æ™ƒå‹• */
    cursor: pointer;
}
.lever-handle {
    transition: top 0.05s linear; /* ç¸®çŸ­å»¶é²æ™‚é–“ï¼Œå¢åŠ å³æ™‚æ„Ÿ */
}

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
.lever-handle {
    cursor: pointer;
    touch-action: none; /* é˜²æ­¢ç§»å‹•ç«¯æ²å‹•å¹²æ“¾ */
}
    </style>
</head>
<body onclick="window.focus()">

<div id="overlay">
    <div id="menu-box" class="box">
        <h2 style="color:var(--color-ato)">é£›ç£éµè·¯é§•é§›æ¨¡æ“¬å™¨</h2>
        <div style="text-align:left;">
            <label>èµ·å§‹è»Šç«™</label><select id="start-sel"></select>
            <label>è¡Œé§›æ–¹å‘</label><select id="dir-sel"><option value="down">ä¸‹è¡Œ (å¾€ å…¨äº¬)</option><option value="up">ä¸Šè¡Œ (å¾€ å·¥æ¥­å€)</option></select>
            <label>è»Šç¨®</label><select id="type-sel"><option value="local">æ™®é€š (Local)</option><option value="express">æ©Ÿå ´å¿«é€Ÿ (Express)</option></select>
        </div>
        <p style="font-size:0.8em; color:#aaa; margin-top:10px; line-height: 1.6;">
            âš ï¸ <strong>æ“ä½œæŒ‡å—ï¼š</strong><br>
            1. ä»»å‹™ç›®æ¨™ï¼šé€£çºŒå®Œæˆ 3 å€‹åœé ç«™ã€‚<br>
            2. å·¦å´é»‘ç·šå°æº–åœè»Šæ¨™è¨˜ (èª¤å·®5må…§ï¼Œ30CMå…§å°¤ä½³)ã€‚<br>
            3. <strong>ä¾ç…§é€Ÿé™è¡Œé§›</strong> (è«‹æ³¨æ„é å‘Šé»ƒç·š)ã€‚<br>
            4. é—œé–€è«‹æŒ‰ Spaceã€‚<br>
        </p>
        <button onclick="initGame()">é–‹å§‹é§•é§› (START)</button>
    </div>
    
    <div id="result-box" class="box" style="display:none;">
        <h1 id="res-title">æª¢å®šå¤±æ•—</h1>
        <p id="res-desc" style="font-size:1.2em; white-space: pre-line;"></p>
        <button onclick="location.reload()" style="background:#fff; color:#000;">é‡æ–°é–‹å§‹</button>
    </div>
</div>

<div id="viewport">
    <div class="scenery-layer" id="city-bg"></div>
    <div id="platform-obj"></div>
    <div id="stop-marker"><div class="stop-sign">åœ</div><div class="stop-pole"></div></div>
    
    <div class="track"><div class="sleeper" id="sleeper"></div></div>
    <div id="train-line"></div>
    <div id="station-sign">è»Šç«™</div>
    <div id="msg-center"></div>
</div>

<div id="dashboard">
    <div class="panel-signal">
        <div style="color:#888; font-size:0.8em;">ATP MONITOR</div>
        <div class="speed-gauge-wrap">
            <svg width="180" height="180" viewBox="0 0 200 200">
                <circle cx="100" cy="100" r="80" class="ring-bg"></circle>
                <circle id="gauge-limit" cx="100" cy="100" r="80" class="ring-limit"></circle>
                <circle id="gauge-speed" cx="100" cy="100" r="80" class="ring-val"></circle>
            </svg>
            <div class="speed-num"><span id="ui-speed">0</span></div>
        </div>
        <div id="lamp-atp" class="lamp">ATP NORM</div>
        
        <div class="ma-container">
            <div class="ma-info" style="font-size:0.7em; display:flex; justify-content:space-between;">
                <span>DIST</span><span id="ui-dist" style="color:var(--color-ato)">0 m</span>
            </div>
            
            <div id="stop-gauge">
                <div id="stop-gauge-line"></div>
                <div id="stop-gauge-dot"></div>
                <div style="position:absolute; left:0; top:0; height:100%; width:1px; background:#999;"></div>
                <div style="position:absolute; right:0; top:0; height:100%; width:1px; background:#999;"></div>
            </div>
            
            <div style="display:flex; justify-content:space-between; font-size:0.6em; color:#888; margin-top:2px;">
                <span>-50cm</span>
                <span>+50cm</span>
            </div>
        </div>
    </div>

    <div class="panel-tcms">
        <div style="border-bottom:1px solid #444; color:var(--color-ato); display:flex; justify-content:space-between;">
            <span>TCMS</span><span id="ui-clock">12:00</span>
        </div>
        
        <div id="ui-status-monitor" class="status-monitor">CHECKING...</div>

        <div class="data-grid">
            <div class="data-item"><div class="data-lbl">CURRENT</div><div class="data-val" id="ui-curr" style="color:var(--color-ok)">-</div></div>
            <div class="data-item"><div class="data-lbl">NEXT STOP</div><div class="data-val" id="ui-next">-</div></div>
            <div class="data-item"><div class="data-lbl">LIMIT</div><div class="data-val" id="ui-limit" style="color:var(--color-atp)">0</div></div>
            <div class="data-item"><div class="data-lbl">GRAD</div><div class="data-val" id="ui-grad">0â€°</div></div>
            <div class="data-item"><div class="data-lbl">DOOR</div><div class="data-val" id="ui-door">CLSD</div></div>
            <div class="data-item"><div class="data-lbl">BC</div><div class="data-val" id="ui-bc">0.0</div></div>
        </div>
        <div id="lamp-door-warn" class="lamp" style="margin-top:auto;">DOOR CLOSING</div>
    </div>

    <div class="panel-controls">
        <div class="lever-group">
            <div style="position:relative;">
                <div class="lever-track"><div class="lever-handle" id="handle-brk"></div></div>
                <div style="text-align:center; font-size:0.6em; margin-top:5px; color:#aaa;">BRK<br>(W/S)</div>
            </div>
            <div style="position:relative;">
                <div class="lever-track"><div class="lever-handle" id="handle-pwr"></div></div>
                <div style="text-align:center; font-size:0.6em; margin-top:5px; color:#aaa;">PWR<br>(A/D)</div>
            </div>
        </div>
        <div style="font-size:0.7em; color:#666; margin-top:5px;">Space=DOOR</div>
    </div>
</div>

<script>
    // --- é€šç”¨å·¥å…·ï¼šè¨ˆç®—ç…è»Šæ›²ç·š (Braking Curve) ---
    function applyBrakingCurve(currentLimit, targetLimit, distToStart, decelRate = 3.5) {
        if (distToStart <= 0) return Math.min(currentLimit, targetLimit);
        if (currentLimit <= targetLimit) return currentLimit;

        // V_allow = sqrt(V_target^2 + 2 * a * d)
        let vTargetMs = targetLimit / 3.6;
        let aMs = (decelRate / 3.6);
        let vAllowMs = Math.sqrt((vTargetMs * vTargetMs) + (2 * aMs * distToStart));
        
        return Math.min(currentLimit, vAllowMs * 3.6);
    }

    // --- è»Šç«™è³‡æ–™ ---
    const STATIONS = [
        { name: "é£›ç£å·¥æ¥­å€", dist: 8400, exp: true, plats: 4 },
        { name: "é£›ç£æ¸¯", dist: 1300, exp: false, plats: 4 },
        { name: "ç‰©æµä¸­å¿ƒ", dist: 1200, exp: false, plats: 2 },
        { name: "é£›ç£éƒµè¼ªæ¸¯", dist: 7200, exp: true, plats: 4 },
        { name: "æ¿±æ±Ÿå•†å‹™å€", dist: 1500, exp: false, plats: 2 },
        { name: "å¸‚æ°‘å»£å ´", dist: 1300, exp: false, plats: 4 },
        { name: "æ–‡åŒ–ä¸­å¿ƒ", dist: 1900, exp: false, plats: 2 },
        { name: "é£›ç£æ–°ç«™", dist: 2300, exp: true, plats: 4 },
        { name: "ç§‘å‰µåœ’", dist: 1200, exp: false, plats: 4 },
        { name: "é£›ç£å­¸å€", dist: 1700, exp: false, plats: 2 },
        { name: "é£›ç£å¤§é“", dist: 1600, exp: false, plats: 2 },
        { name: "é£›ç£å…¬åœ’", dist: 1400, exp: true, plats: 4 },
        { name: "éŒ¦æ¹–", dist: 500, exp: false, plats: 2 },
        { name: "é·ºå³¶", dist: 2800, exp: false, plats: 2 },
        { name: "ç©ºæ¸¯æ–°åŸ", dist: 4900, exp: false, plats: 2 },
        { name: "é£›ç£æ©Ÿå ´", dist: 5200, exp: true, plats: 4 },
        { name: "ç¿¡ç¿ èŠ±åœ’", dist: 3200, exp: false, plats: 2 },
        { name: "ç´«èŠè‹‘", dist: 9600, exp: false, plats: 4 },
        { name: "å¾¡æ™¯æ–°æ‘", dist: 9000, exp: false, plats: 2 },
        { name: "è‡ªç„¶ä¿è‚²ä¸­å¿ƒ", dist: 1800, exp: false, plats: 2 },
        { name: "ç¶¾è·¯åŒ—ç«™", dist: 1200, exp: true, plats: 4 },
        { name: "å…¨äº¬å¤§é“", dist: 0, exp: false, plats: 2 }
    ];

    const PHY = { MASS: 180000, MAX_TRAC: 185000, MAX_BRK: 240000, AERO: 6.0, ROLL: 2000, G: 9.8 };
    const CIRCUMFERENCE = 502; 

    let state = {
        active: false,
        v: 0, d: 0, 
        p: 0, b: 4, 
        door: true, doorClosing: false, doorTimer: 0,
        route: [], idx: 0, stops: 0,
        type: 'local', dir: 'down',
        lastT: 0,
        atpLimit: 120, targetLimit: 120, grade: 0,
        timerInt: null
    };

    let sndWarn;
    try { sndWarn = new Audio('warning.m4a'); sndWarn.volume = 1.0; } catch(e){}

    const ui = {
        spd: document.getElementById('ui-speed'),
        rSpd: document.getElementById('gauge-speed'),
        rLim: document.getElementById('gauge-limit'),
        dist: document.getElementById('ui-dist'),
        gaugeDot: document.getElementById('stop-gauge-dot'),
        hPwr: document.getElementById('handle-pwr'),
        hBrk: document.getElementById('handle-brk'),
        bg: document.getElementById('city-bg'),
        slp: document.getElementById('sleeper'),
        sign: document.getElementById('station-sign'),
        plat: document.getElementById('platform-obj'),
        mark: document.getElementById('stop-marker'),
        msg: document.getElementById('msg-center'),
        door: document.getElementById('ui-door'),
        curr: document.getElementById('ui-curr'),
        next: document.getElementById('ui-next'),
        bc: document.getElementById('ui-bc'),
        lim: document.getElementById('ui-limit'),
        grad: document.getElementById('ui-grad'),
        status: document.getElementById('ui-status-monitor'),
        lampDoor: document.getElementById('lamp-door-warn'),
        lampAtp: document.getElementById('lamp-atp'),
        menu: document.getElementById('menu-box'),
        resBox: document.getElementById('result-box'),
        overlay: document.getElementById('overlay')
    };

    window.onload = () => {
        const sel = document.getElementById('start-sel');
        STATIONS.forEach((s, i) => {
            let o = document.createElement('option');
            o.value = i; o.innerText = s.name;
            sel.appendChild(o);
        });
        window.addEventListener('keydown', handleKey);
        window.focus();
    };

    function initGame() {
        const sIdx = parseInt(document.getElementById('start-sel').value);
        state.dir = document.getElementById('dir-sel').value;
        state.type = document.getElementById('type-sel').value;

        if(state.type === 'express') {
            if(!STATIONS[sIdx].exp) return alert("æ­¤ç«™ç„¡ç›´é”è»Šåœé ï¼Œç„¡æ³•ç™¼è»Š");
            if(STATIONS[sIdx].name === "å…¨äº¬å¤§é“") return alert("ç›´é”è»Šä¸å¯å¾å…¨äº¬å¤§é“å‡ºç™¼");
        }

        let raw = (state.dir === 'down') ? STATIONS.slice(sIdx) : [...STATIONS].reverse().slice((STATIONS.length-1)-sIdx);
        
        let validStops = 0;
        for(let i=1; i < raw.length; i++) {
            if (state.type === 'local') {
                validStops++;
            } else if (state.type === 'express') {
                if (raw[i].exp) validStops++;
            }
            if(validStops >= 3) break;
        }

        if (validStops < 3) {
            return alert(`å‰©é¤˜åœé ç«™ä¸è¶³ 3 ç«™ï¼Œç„¡æ³•å»ºç«‹è¡Œç¨‹ï¼\n(ç›®å‰åªæœ‰ ${validStops} å€‹åœé ç«™)\n\nè«‹å˜—è©¦æ›´æ›èµ·é»ã€æ–¹å‘æˆ–æ”¹é–‹æ™®é€šè»Šã€‚`);
        }

        state.route = [{ name: raw[0].name, dist: 0, data: raw[0], isStop: true }];
        let stopCounter = 0; 

        for(let i=0; i<raw.length-1; i++) {
            if(stopCounter >= 3) break; 

            let cur = raw[i], nxt = raw[i+1];
            let segmentDist = (state.dir === 'down') ? cur.dist : nxt.dist;
            
            let shouldStop = true;
            if(state.type === 'express') {
                if(!nxt.exp) shouldStop = false;
            }
            
            state.route.push({ 
                name: nxt.name, 
                dist: segmentDist, 
                data: nxt,
                isStop: shouldStop 
            });

            if(shouldStop) stopCounter++;
        }

        state.active = true; state.v = 0; 
        state.d = state.route[1].dist; 
        state.p = 0; state.b = 4; 
        state.door = true; state.doorClosing = false;
        state.idx = 0; state.stops = 0;
        state.atpLimit = 120;
        
        ui.menu.style.display = 'none';
        ui.overlay.style.display = 'none';
        ui.door.innerText = "OPEN"; ui.door.style.color = "var(--color-err)";
        ui.curr.innerText = state.route[0].name;
        
        let nextInfo = getNextStopInfo();
        ui.next.innerText = nextInfo.name;
        ui.dist.innerText = Math.floor(nextInfo.dist) + " m";

        setObjPos(0);
        updateUI();
        calcEnv(0); 
        state.lastT = performance.now();
        requestAnimationFrame(loop);
    }

    function loop(now) {
        if(!state.active) return;
        let dt = (now - state.lastT)/1000;
        if(dt > 0.1) dt = 0.1;
        state.lastT = now;

        calcEnv(dt);
        updateStatus(); 

        if(state.door || state.doorClosing) {
            state.v = 0;
        } else {
            let traction = 0;
            if(state.p > 0 && state.b === 0) {
                let r = Math.abs(state.v) / (130/3.6);
                let f = Math.max(0.65, 1 - r*0.35);
                traction = (state.p/4) * PHY.MAX_TRAC * f;
            }

            let brakeMax = (state.b/8) * PHY.MAX_BRK;
            let dragMag = PHY.ROLL + (PHY.AERO * state.v * state.v);
            let dragForce = (state.v > 0) ? -dragMag : (state.v < 0 ? dragMag : 0);
            let gradeF = PHY.MASS * PHY.G * (state.grade / 1000); 

            let propelling = traction + dragForce - gradeF; 
            let net = (state.v > 0) ? propelling - brakeMax : propelling + brakeMax;

            if (Math.abs(state.v) < 0.05 && state.p === 0 && Math.abs(propelling) <= brakeMax) {
                net = 0;      
                state.v = 0;  
            }

            let acc = net / PHY.MASS;
            state.v += acc * dt;
            
            if (Math.abs(state.grade) < 1 && Math.abs(state.v) < 0.001 && state.p === 0) state.v = 0;

            let mv = state.v * dt;
            state.d -= mv;

            if (state.d < -5 && state.route[state.idx+1] && state.route[state.idx+1].isStop) {
                gameOver("è¶…éåœè»Šä½ç½® 5m (éç«™ä¸åœ)", false);
                return;
            }

            if(state.d <= 0 && state.idx < state.route.length - 1) {
                let nextSt = state.route[state.idx+1];
                if(!nextSt.isStop) {
                    state.idx++;
                    if(state.idx < state.route.length - 1) {
                        state.d += state.route[state.idx+1].dist;
                        showMsg(nextSt.name + " é€šé");
                        ui.curr.innerText = state.route[state.idx].name;
                    } else {
                        state.d = 0;
                    }
                }
            }

            if(state.v*3.6 > state.atpLimit + 2) {
                gameOver("ATP OVERSPEED (è¶…é€Ÿ)");
                return;
            }
        }
        updateUI(); 
        requestAnimationFrame(loop);
    }

    // --- ç‰©ç†ç’°å¢ƒè¨ˆç®— (v21.0ï¼šå…¨ç·šç›´é”è»Šå½é“ä¿®æ­£) ---
    function calcEnv(dt) {
        if(state.idx >= state.route.length-1) return;
        
        let curSt = state.route[state.idx];   
        let nxtSt = state.route[state.idx+1]; 
        let distRem = state.d;              
        let distTrav = nxtSt.dist - state.d; 

        let limit = 120;      
        let predLimit = 120;  
        let grade = 0;
        let lookAheadDist = Math.abs(state.v) * 3.0; 

        const applyLimitPair = (target, distToStart) => {
            limit = applyBrakingCurve(limit, target, distToStart);
            predLimit = applyBrakingCurve(predLimit, target, distToStart - lookAheadDist);
        };

        const TERMINALS = ["é£›ç£å·¥æ¥­å€", "ç¶¾è·¯åŒ—ç«™", "å…¨äº¬å¤§é“"]; 
        const checkSwitchLimit = (stInfo) => {
            if (TERMINALS.includes(stInfo.name)) return true;
            if (state.type === 'local' && stInfo.data.plats >= 4) return true;
            return false;
        };

        if (curSt.isStop && distTrav < 300) { 
            if (checkSwitchLimit(curSt)) {
                limit = Math.min(limit, 45); 
                predLimit = Math.min(predLimit, 45); 
            }
        }
        
        if (nxtSt.isStop) {
            if (checkSwitchLimit(nxtSt)) {
                applyLimitPair(45, distRem - 300);
            }
        }

        let pName = curSt.name; 
        let nName = nxtSt.name; 

        if (state.dir === 'down') {
            // ==========================================
            // ä¸‹è¡Œæ–¹å‘ (å¾€ å…¨äº¬)
            // ==========================================

            // 1. å¾€ é£›ç£éƒµè¼ªæ¸¯ (é€²ç«™å¡åº¦åœ¨ 250m çµæŸ)
            if (nName === "é£›ç£éƒµè¼ªæ¸¯") {
                if (distRem <= 1000 && distRem > 250) grade = -15; 
                applyLimitPair(75, distRem - 600);
            }

            // 2. å¾€ å¸‚æ°‘å»£å ´
            if (nName === "å¸‚æ°‘å»£å ´") applyLimitPair(75, distRem - 600);
            
            // 3. å¾€ é£›ç£å…¬åœ’
            if (nName === "é£›ç£å…¬åœ’") {
                 if (distRem > 250 && distRem <= 950) grade = 15;
                 // é å‘Šå‡ºç«™å¾Œçš„é™é€Ÿ
                 applyLimitPair(90, distRem + 800); 
            }
            
            // 4. é›¢é–‹ é£›ç£å…¬åœ’ (æ¥éŒ¦æ¹–)
            if (pName === "é£›ç£å…¬åœ’") {
                if (distTrav < 800) {
                    applyLimitPair(60, 300 - distTrav);
                    applyLimitPair(90, 800 - distTrav);
                }
                if (distTrav >= 800) { limit = Math.min(limit, 90); predLimit = Math.min(predLimit, 90); }
            }
            
            // [æ–°å¢] 5. é€šé éŒ¦æ¹– (ä¸‹è¡Œ ç›´é”è»Šé˜²è­·)
            // èªªæ˜ï¼šé£›ç£å…¬åœ’å‡ºç«™é™é€Ÿ90ï¼Œé€²å…¥éŒ¦æ¹–å€é–“(500m)å¾Œï¼Œè‹¥ä¸ç¶­æŒé™é€Ÿæœƒè·³å›120
            if (pName === "éŒ¦æ¹–") {
                limit = Math.min(limit, 90); 
                predLimit = Math.min(predLimit, 90); 
            }

            // 6. é›¢é–‹ é·ºå³¶ (å‡ºç«™å¡åº¦ 250m å¾Œé–‹å§‹)
            if (pName === "é·ºå³¶") {
                if (distTrav > 250 && distTrav <= 600) grade = -15;
            }
            
            // 7. å¾€ é£›ç£æ©Ÿå ´
            if (nName === "é£›ç£æ©Ÿå ´") applyLimitPair(90, distRem - 600);

            // 8. å¾€ ç©ºæ¸¯æ–°åŸ
            if (nName === "ç©ºæ¸¯æ–°åŸ") applyLimitPair(90, distRem - 600);
            
	    // 9. é›¢é–‹ é£›ç£æ©Ÿå ´ (ä¿®æ­£ï¼šåŠ å…¥é€Ÿé™è§£é™¤èˆ‡ç›´é”è»Šé‚è¼¯)
            if (pName === "é£›ç£æ©Ÿå ´") {
                // å½é“ä½æ–¼å‡ºç™¼å¾Œ 300m
                if (distTrav < 300) applyLimitPair(90, 300 - distTrav);
                
                // ä¿®æ­£ï¼šåªæœ‰åœ¨ 300m ~ 1000m ä¹‹é–“é–å®š 90ï¼Œè¶…éå¾Œè§£é™¤
                if (distTrav >= 300 && distTrav < 1000) { 
                    limit = Math.min(limit, 90); 
                    predLimit = Math.min(predLimit, 90); 
                }
                
                // çˆ¬å¡é‚è¼¯ç¶­æŒä¸è®Š
                if (distTrav >= 800 && distTrav < 1467) grade = 15;
            }
            
            // 10. é›¢é–‹ ç´«èŠè‹‘
            if (pName === "ç´«èŠè‹‘" && distTrav > 250 && distTrav <= 600) grade = -15;

        } else {
            // ==========================================
            // ä¸Šè¡Œæ–¹å‘ (å¾€ å·¥æ¥­å€)
            // ==========================================

            // 1. å¾€ ç´«èŠè‹‘
            if (nName === "ç´«èŠè‹‘" && distRem <= 800 && distRem > 250) grade = 15;
            
	    // 2. å¾€ é£›ç£æ©Ÿå ´ (ä¿®æ­£ï¼šåŠ å…¥æœˆå°é•·åº¦è¨ˆç®—)
            if (nName === "é£›ç£æ©Ÿå ´") {
                // é¡Œç›®ï¼šå½é“åœ¨å‡ºç™¼å´ 0.3kmã€‚
                // ä¸Šè¡Œé€²ç«™æ™‚ï¼Œè·é›¢åœè»Šé» = 300m (å½é“) + 175m (æœˆå°é•·åº¦) = 475m
                // æ‰€ä»¥è¦åœ¨è·é›¢åœè»Šé» 475m è™•å°‡é€Ÿåº¦é™è‡³ 90
                applyLimitPair(90, distRem - 475);
                
                // é€™è£¡åŸæœ¬æœ‰çˆ¬å¡é‚è¼¯ï¼Œä¿ç•™
                if (distRem > 600 && distRem < 1500) grade = -15; 
            }
            
            // 3. å¾€ ç©ºæ¸¯æ–°åŸ (ç›´é”è»Šé å‘Š)
            if (nName === "ç©ºæ¸¯æ–°åŸ") applyLimitPair(90, distRem); 
            
            // 4. é›¢é–‹ ç©ºæ¸¯æ–°åŸ
            if (pName === "ç©ºæ¸¯æ–°åŸ" && distTrav <= 600) { 
                limit = Math.min(limit, 90); predLimit = Math.min(predLimit, 90); 
            }

            // [æ–°å¢] 5. é€šé éŒ¦æ¹– (ä¸Šè¡Œ ç›´é”è»Šé˜²è­·)
            // èªªæ˜ï¼šå¾éŒ¦æ¹–(éç«™ä¸åœ)åˆ°é£›ç£å…¬åœ’åªæœ‰1400mã€‚
            // é£›ç£å…¬åœ’å‰çš„90é€Ÿé™éœ€è¦åœ¨ 2000m è™•é–‹å§‹é å‘Šã€‚
            // 1400 < 2000ï¼Œæ‰€ä»¥åœ¨æŠµé”éŒ¦æ¹–æ™‚ï¼Œå°±å¿…é ˆé™åˆ¶åœ¨ 90 ä»¥ä¸‹ã€‚
            if (nName === "éŒ¦æ¹–") {
                applyLimitPair(90, distRem);
            }

            // 6. å¾€ é·ºå³¶
            if (nName === "é·ºå³¶" && distRem <= 800 && distRem > 250) grade = 15;
            
            // 7. å¾€ é£›ç£å…¬åœ’
            if (nName === "é£›ç£å…¬åœ’") {
                applyLimitPair(90, distRem - 2000);
                applyLimitPair(60, distRem - 600);
            }
            if (pName === "é£›ç£å…¬åœ’" && distTrav > 250 && distTrav <= 950) grade = -15;

            // 8. å¾€ å¸‚æ°‘å»£å ´ (ç›´é”è»Šé å‘Š)
            if (nName === "å¸‚æ°‘å»£å ´") applyLimitPair(75, distRem);

            // 9. é›¢é–‹ å¸‚æ°‘å»£å ´
            if (pName === "å¸‚æ°‘å»£å ´" && distTrav <= 600) { 
                limit = Math.min(limit, 75); predLimit = Math.min(predLimit, 75); 
            }
            
            // 10. å¾€ é£›ç£éƒµè¼ªæ¸¯ (ç›´é”è»Šé å‘Š)
            if (nName === "é£›ç£éƒµè¼ªæ¸¯") applyLimitPair(75, distRem); 

            // 11. é›¢é–‹ é£›ç£éƒµè¼ªæ¸¯
            if (pName === "é£›ç£éƒµè¼ªæ¸¯") {
                if (distTrav <= 600) { limit = Math.min(limit, 75); predLimit = Math.min(predLimit, 75); }
                if (distTrav > 250 && distTrav <= 850) grade = 15; 
            }
        }

        if (state.door || state.doorClosing) {
            state.targetLimit = limit;
            state.atpLimit = limit; 
            if(ui.lampAtp) {
                ui.rLim.classList.remove('flashing');
                ui.lampAtp.classList.remove('warn'); ui.lampAtp.classList.remove('on');
                ui.lampAtp.innerText = "ATP NORM";
            }
            return; 
        }

        state.targetLimit = limit;
        state.grade = grade;
        state.atpLimit = state.targetLimit; 

        if (ui.lampAtp) {
            let currentSpd = Math.abs(state.v * 3.6);
            if (currentSpd > predLimit) { 
                ui.rLim.classList.add('flashing');
                ui.lampAtp.classList.add('warn');
                ui.lampAtp.classList.remove('on');
                ui.lampAtp.innerText = "ATP WARN";
            } else {
                ui.rLim.classList.remove('flashing');
                ui.lampAtp.classList.remove('warn');
                ui.lampAtp.classList.remove('on');
                ui.lampAtp.innerText = "ATP NORM";
            }
        }
    }

    function getNextStopInfo() {
        if (!state.route[state.idx+1]) return { name: "END", dist: 0 };
        let totalDist = state.d;
        let stopName = state.route[state.idx+1].name;
        for (let i = state.idx + 1; i < state.route.length - 1; i++) {
            let node = state.route[i];
            if (!node.isStop) {
                if (state.route[i+1]) {
                    totalDist += state.route[i+1].dist;
                    stopName = state.route[i+1].name;
                }
            } else {
                break; 
            }
        }
        return { name: stopName, dist: totalDist };
    }

    function inputDoor() {
        if(state.doorClosing) return; 
        if(state.door) {
            state.doorClosing = true; state.doorTimer = 15;
            if(sndWarn) { sndWarn.currentTime = 0; sndWarn.play().catch(()=>{}); }
            ui.msg.innerText = "âš ï¸ é—œé–€ä¸­: 15"; ui.msg.style.display = "block";
            ui.lampDoor.classList.add('on');
            if(state.timerInt) clearInterval(state.timerInt);
            state.timerInt = setInterval(() => {
                state.doorTimer--;
                ui.msg.innerText = "âš ï¸ é—œé–€ä¸­: " + state.doorTimer;
                if(state.doorTimer <= 0) {
                    clearInterval(state.timerInt);
                    state.door = false; state.doorClosing = false;
                    ui.lampDoor.classList.remove('on');
                    ui.door.innerText = "CLSD"; ui.door.style.color = "var(--color-ok)";
                    if(state.idx < state.route.length - 1) state.d = state.route[state.idx+1].dist;
                    ui.msg.innerText = "ğŸŸ¢ ç™¼è»Šï¼ (READY)";
                    setTimeout(() => ui.msg.style.display = "none", 2000);
                    updateUI(); 
                }
            }, 1000);
        } else {
            if(Math.abs(state.v) < 0.05) {
                let distM = state.d; 
                let err = Math.abs(distM);
                
                if(err > 5) { 
                    let statusStr = distM > 0 ? "æœªé”" : "è¶…é";
                    gameOver(`åœè»Šèª¤å·®éå¤§ï¼\n${statusStr} ${err.toFixed(2)}m\n(æ¨™æº–ï¼šÂ±5m å…§)`, false);
                    return; 
                }

                let cm = Math.round(distM * 100); 
                let resultText = "";
                
                if (cm > 0) {
                    resultText = `æœªé” ${cm} cm`;
                } else if (cm < 0) {
                    resultText = `è¶…é ${Math.abs(cm)} cm`;
                } else {
                    resultText = `ğŸ”¥ å®Œç¾åœè»Š 0 cm ğŸ”¥`;
                }

                state.door = true;
                ui.door.innerText = "OPEN"; ui.door.style.color = "var(--color-err)";
                state.stops++;

                if(state.idx >= state.route.length - 2) { 
                    gameOver(`æª¢å®šé€šéï¼\næœ€çµ‚ç«™èª¤å·®: ${resultText}`, true);
                } else {
                    state.idx++; 
                    ui.curr.innerText = state.route[state.idx].name;
                    let info = getNextStopInfo();
                    ui.next.innerText = info.name;
                    
                    showMsg(`åœé æˆåŠŸ\n${resultText}`);
                    
                    setObjPos(0); 
                }
            } else showMsg("è¡Œé§›ä¸­ç„¡æ³•é–‹é–€");
        }
    }

    function inputPower(delta) {
        if(state.door || state.doorClosing) return; 
        if(state.b > 0) return; 
        let newP = state.p + delta;
        if(newP > 4) newP = 4; if(newP < 0) newP = 0;
        state.p = newP;
        updateUI();
    }

    function inputBrake(delta) {
        let newB = state.b + delta;
        if(newB > 8) newB = 8; if(newB < 0) newB = 0;
        state.b = newB;
        if(state.b > 0) state.p = 0; 
        updateUI();
    }

    function handleKey(e) {
        if(!state.active) return;
        switch(e.key.toLowerCase()) {
            case 'a': case 'arrowleft': inputPower(1); break;
            case 'd': case 'arrowright': inputPower(-1); break;
            case 'w': case 'arrowup': inputBrake(1); break;
            case 's': case 'arrowdown': inputBrake(-1); break;
            case ' ': inputDoor(); break;
        }
    }

    function updateStatus() {
        let msg = "", color = "#888";
        if(state.doorClosing) { msg=`â³ é—œé–€ä¸­ (${state.doorTimer})`; color="var(--color-atp)"; }
        else if(state.door) { msg="â›” è»Šé–€é–‹å•Ÿ (DOOR OPEN)"; color="var(--color-err)"; }
        else if(state.b > 0) { msg=`â›” ç…è»Šæœªé¬† (B${state.b})`; color="var(--color-err)"; }
        else if(state.p === 0) { msg="âšª æƒ°è¡Œä¸­ (Coasting)"; color="#fff"; }
        else { msg=`ğŸŸ¢ åŠ é€Ÿä¸­ (P${state.p})`; color="var(--color-ok)"; }
        ui.status.innerText = msg; ui.status.style.color = color; ui.status.style.borderColor = color;
    }

    function updateUI() {
        let kph = state.v * 3.6;
        ui.spd.innerText = Math.floor(Math.abs(kph));
        let limPct = state.atpLimit / 140; if(limPct>1) limPct=1;
        ui.rLim.style.strokeDasharray = `${limPct * CIRCUMFERENCE} 1000`;
        let spdPct = Math.abs(kph) / 140; if(spdPct>1) spdPct=1;
        ui.rSpd.style.strokeDasharray = `${spdPct * CIRCUMFERENCE} 1000`;

        let nextInfo = getNextStopInfo();
        ui.dist.innerText = Math.floor(nextInfo.dist) + " m";
        ui.next.innerText = nextInfo.name;

        let dist = state.d;
        if (Math.abs(dist) <= 0.5) {
            ui.gaugeDot.style.display = 'block';
            let pct = (dist + 0.5) * 100;
            if(pct < 0) pct = 0; if(pct > 100) pct = 100;
            ui.gaugeDot.style.left = pct + "%";
        } else {
            ui.gaugeDot.style.display = 'none';
        }

        ui.bc.innerText = ((state.b/8)*4.5).toFixed(1);
        ui.lim.innerText = Math.floor(state.atpLimit);
        ui.grad.innerText = state.grade + "â€°";
        
        if(state.grade > 0) ui.grad.style.color = "var(--color-err)";
        else if(state.grade < 0) ui.grad.style.color = "var(--color-ok)";
        else ui.grad.style.color = "#eee";

        let px = (state.v * (1/60)) * 10; 
        moveBg(ui.slp, px);
        moveBg(ui.bg, px * 0.1);
        setObjPos(state.d);

        ui.hPwr.style.top = (90 - state.p*20) + "%";
        ui.hBrk.style.top = (90 - state.b*10) + "%";
    }

// ç‚ºé›»é–€è»Œé“åŠ å…¥é»æ“Šäº‹ä»¶
document.getElementById('handle-pwr').parentElement.onclick = function(e) {
    let rect = this.getBoundingClientRect();
    let y = e.clientY - rect.top;
    let pct = 1 - (y / rect.height); // æ›ç®—ç™¾åˆ†æ¯”
    state.p = Math.round(pct * 4);
    if(state.p < 0) state.p = 0;
    if(state.p > 4) state.p = 4;
    if(state.p > 0) state.b = 0; // æ¨é€²æ™‚é¬†ç…è»Š
    updateUI();
};

// ç‚ºç…è»Šè»Œé“åŠ å…¥é»æ“Šäº‹ä»¶
document.getElementById('handle-brk').parentElement.onclick = function(e) {
    let rect = this.getBoundingClientRect();
    let y = e.clientY - rect.top;
    let pct = 1 - (y / rect.height);
    state.b = Math.round(pct * 8);
    if(state.b < 0) state.b = 0;
    if(state.b > 8) state.b = 8;
    if(state.b > 0) state.p = 0; // ç…è»Šæ™‚æ–·å‹•åŠ›
    updateUI();
};

// é‡å°è»Šé–€ç‹€æ…‹ç‡ˆåŠ å…¥é»æ“Šæ“ä½œ (é»æ“Š TCMS å€çš„ DOOR ä¹Ÿå¯ä»¥é–‹é—œé–€)
document.getElementById('ui-door').parentElement.onclick = function() {
    inputDoor();
};

    function moveBg(el, dx) {
        let pos = parseFloat(el.style.backgroundPositionX) || 0;
        el.style.backgroundPositionX = (pos - dx) + "px";
    }

    function setObjPos(dist) {
        let cx = window.innerWidth * 0.2; 
        let off = dist * 10;
        let pos = cx + off;
        
        if(dist > 3000 || dist < -1000) {
            ui.plat.style.left = "200%"; ui.mark.style.left = "200%"; ui.sign.style.left = "200%";
            return;
        }
        
        let nextSt = state.route[state.idx+1];
        if (nextSt && !nextSt.isStop) {
            ui.mark.style.display = 'none';
        } else {
            ui.mark.style.display = 'flex';
            ui.mark.style.left = (pos - 10) + "px"; 
        }

        ui.plat.style.left = (pos - 1750) + "px";
        ui.sign.style.left = (pos - 800) + "px";

        let showIdx = state.idx + 1;
        if (state.door && state.route[state.idx]) {
            showIdx = state.idx; 
        }
        if(state.route[showIdx]) {
            ui.sign.innerText = state.route[showIdx].name;
        }
    }

    function showMsg(txt) {
        ui.msg.innerText = txt; ui.msg.style.display = 'block';
        setTimeout(()=>ui.msg.style.display='none', 2000);
    }

    function gameOver(reason, win=false) {
        state.active = false; clearInterval(state.timerInt);
        ui.overlay.style.display = 'flex'; ui.menu.style.display = 'none';
        ui.resBox.style.display = 'block';
        ui.resBox.className = win ? "box win-box" : "box fail-box";
        document.getElementById('res-title').innerText = win ? "æª¢å®šé€šé" : "æª¢å®šå¤±æ•—";
        document.getElementById('res-desc').innerText = reason;
    }

    setInterval(()=>document.getElementById('ui-clock').innerText=new Date().toLocaleTimeString('zh-TW',{hour12:false}), 1000);

// å°è£æ‹–æ›³è™•ç†å‡½æ•¸
function setupDraggable(handleId, trackId, type) {
    const handle = document.getElementById(handleId);
    const track = handle.parentElement;

    function handleDrag(e) {
        // å–å¾—è§¸æ§æˆ–æ»‘é¼ ä½ç½®
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const rect = track.getBoundingClientRect();
        
        // è¨ˆç®—ç™¾åˆ†æ¯” (0.0 ~ 1.0)
        let pct = 1 - ((clientY - rect.top) / rect.height);
        if (pct < 0) pct = 0;
        if (pct > 1) pct = 1;

        if (type === 'power') {
            if (state.door || state.doorClosing) return; // é–‹é–€æ™‚ç¦å‹•é›»é–€
            state.p = Math.round(pct * 4);
            if (state.p > 0) state.b = 0; // æ¨é›»é–€æ™‚è‡ªå‹•é¬†ç…è»Š
        } else if (type === 'brake') {
            state.b = Math.round(pct * 8);
            if (state.b > 0) state.p = 0; // æ¨ç…è»Šæ™‚è‡ªå‹•æ–·å‹•åŠ›
        }
        
        updateUI();
        updateStatus();
    }

    // ç›£è½è§¸æ§ç§»å‹•
    track.addEventListener('touchstart', (e) => { e.preventDefault(); handleDrag(e); }, {passive: false});
    track.addEventListener('touchmove', (e) => { e.preventDefault(); handleDrag(e); }, {passive: false});
    
    // ç›£è½æ»‘é¼ æ‹–æ›³ (é›»è…¦ç‰ˆééµç›¤æ“ä½œæ”¯æ´)
    track.addEventListener('mousedown', (e) => {
        handleDrag(e);
        const onMouseMove = (me) => handleDrag(me);
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', () => {
            document.removeEventListener('mousemove', onMouseMove);
        }, {once: true});
    });
}

// åˆå§‹åŒ–è§¸æ§æ§åˆ¶
setupDraggable('handle-pwr', 'lever-track', 'power');
setupDraggable('handle-brk', 'lever-track', 'brake');

// å¢åŠ è»Šé–€å€å¡Šé»æ“Šå›é¥‹
document.querySelector('.panel-tcms').addEventListener('click', (e) => {
    // é»æ“Š TCMS å€åŸŸä»»ä¸€è™•æ¨¡æ“¬æŒ‰ä¸‹è»Šé–€éˆ•
    if (Math.abs(state.v) < 0.1) inputDoor();
});

</script>
</body>
</html>